<!-- src/app/citoyen-dashboard/citoyen-dashboard.html - Version mise √† jour avec donn√©es temps r√©el -->

<app-header></app-header>

<!-- Container principal du dashboard -->
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-50 p-4">
  <div class="container mx-auto max-w-6xl">

    <!-- En-t√™te de bienvenue -->
    <div class="mb-8">
      <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
              üèôÔ∏è Bienvenue {{ currentUser?.prenom }} !
            </h1>
            <p class="text-gray-600">
              D√©couvrez les donn√©es IoT de Tech City ({{ donneeEnTempsReel?.villeNom || 'Paris' }}) en temps r√©el
            </p>
            <div class="mt-2 text-sm text-blue-600">
              üìç {{ currentUser?.donneesSpecifiques?.latitude }}, {{ currentUser?.donneesSpecifiques?.longitude }}
            </div>

            <!-- Indicateur de derni√®re mise √† jour -->
            <div class="mt-3 flex items-center space-x-4">
              <div class="flex items-center space-x-2 text-sm">
                <mat-icon [class]="isLoading ? 'animate-spin text-blue-500' : 'text-green-500'" class="text-sm">
                  {{ isLoading ? 'refresh' : 'check_circle' }}
                </mat-icon>
                <span [class]="isLoading ? 'text-blue-600' : 'text-green-600'">
                  {{ isLoading ? 'Mise √† jour en cours...' : 'Derni√®re mise √† jour: ' + getLastUpdateString() }}
                </span>
              </div>

              <!-- Bouton de rafra√Æchissement manuel -->
              <button
                mat-icon-button
                (click)="refreshData()"
                [disabled]="isLoading"
                class="text-blue-500"
                title="Rafra√Æchir manuellement">
                <mat-icon [class]="isLoading ? 'animate-spin' : ''">refresh</mat-icon>
              </button>
            </div>
          </div>
          <div class="text-right">
            <button
              mat-raised-button
              color="warn"
              (click)="logout()"
              class="mb-2">
              <mat-icon class="mr-2">logout</mat-icon>
              Se d√©connecter
            </button>
            <div class="text-xs text-gray-500">
              Connect√© en tant que {{ currentUser?.role }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message d'erreur si pas de donn√©es -->
    @if (error && !isLoading) {
      <div class="mb-8 bg-red-50 border-l-4 border-red-400 p-4 rounded-lg">
        <div class="flex items-center">
          <mat-icon class="text-red-400 mr-3">error</mat-icon>
          <div>
            <h3 class="font-medium text-red-800">Donn√©es indisponibles</h3>
            <p class="text-red-700 text-sm mt-1">{{ error }}</p>
          </div>
        </div>
      </div>
    }

    <!-- Grille des donn√©es IoT en temps r√©el -->
    <mat-grid-list cols="1" rowHeight="320px" gutterSize="16"
                   [cols]="getGridCols()"
                   class="mb-8">

      <!-- Carte Qualit√© de l'Air -->
      <mat-grid-tile>
        <mat-card class="w-full h-full hover-azure">
          <mat-card-header>
            <mat-icon
              mat-card-avatar
              [style.background-color]="getQualiteAirColor()"
              class="text-white">
              air
            </mat-icon>
            <mat-card-title>Qualit√© de l'Air</mat-card-title>
            <mat-card-subtitle>Tech City - Temps r√©el</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="flex-1 flex flex-col justify-center">
            @if (isLoading) {
              <div class="text-center">
                <mat-icon class="animate-spin text-4xl text-blue-500 mb-4">refresh</mat-icon>
                <div class="text-gray-600">Chargement...</div>
              </div>
            } @else if (donneeEnTempsReel) {
              <div class="text-center">
                <div class="text-4xl font-bold mb-2" [style.color]="getQualiteAirColor()">
                  {{ donneeEnTempsReel.qualiteAirResume }}
                </div>
                <div class="text-sm text-gray-600 mb-4">
                  PM10: {{ donneeEnTempsReel.pm10 | number:'1.1-1' }} Œºg/m¬≥<br>
                  CO: {{ donneeEnTempsReel.co | number:'1.1-1' }} mg/m¬≥
                </div>
                <mat-progress-bar
                  mode="determinate"
                  [value]="getQualiteAirProgress()"
                  [color]="getQualiteAirProgress() > 75 ? 'primary' : getQualiteAirProgress() > 50 ? 'accent' : 'warn'">
                </mat-progress-bar>
              </div>
            } @else {
              <div class="text-center text-gray-500">
                <mat-icon class="text-4xl mb-2">cloud_off</mat-icon>
                <div>Aucune donn√©e</div>
              </div>
            }
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="primary">Voir d√©tails</button>
          </mat-card-actions>
        </mat-card>
      </mat-grid-tile>

      <!-- Carte Temp√©rature -->
      <mat-grid-tile>
        <mat-card class="w-full h-full hover-azure">
          <mat-card-header>
            <mat-icon
              mat-card-avatar
              [style.background-color]="getTemperatureColor()"
              class="text-white">
              thermostat
            </mat-icon>
            <mat-card-title>Temp√©rature</mat-card-title>
            <mat-card-subtitle>Conditions actuelles</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="flex-1 flex flex-col justify-center">
            @if (isLoading) {
              <div class="text-center">
                <mat-icon class="animate-spin text-4xl text-blue-500 mb-4">refresh</mat-icon>
                <div class="text-gray-600">Chargement...</div>
              </div>
            } @else if (donneeEnTempsReel) {
              <div class="text-center">
                <div class="text-4xl font-bold mb-2" [style.color]="getTemperatureColor()">
                  {{ donneeEnTempsReel.temperatureCelsius | number:'1.1-1' }}¬∞C
                </div>
                <div class="text-sm text-gray-600 mb-4">
                  Ressentie: {{ donneeEnTempsReel.temperatureFahrenheit | number:'1.0-0' }}¬∞F<br>
                  Humidit√©: {{ donneeEnTempsReel.humidite | number:'1.0-0' }}%
                </div>
                <mat-progress-bar
                  mode="determinate"
                  [value]="getTemperatureProgress()"
                  color="accent">
                </mat-progress-bar>
              </div>
            } @else {
              <div class="text-center text-gray-500">
                <mat-icon class="text-4xl mb-2">thermostat_off</mat-icon>
                <div>Aucune donn√©e</div>
              </div>
            }
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="primary">Historique</button>
          </mat-card-actions>
        </mat-card>
      </mat-grid-tile>

      <!-- Carte Humidit√© -->
      <mat-grid-tile>
        <mat-card class="w-full h-full hover-azure">
          <mat-card-header>
            <mat-icon mat-card-avatar class="bg-blue-500 text-white">water_drop</mat-icon>
            <mat-card-title>Humidit√©</mat-card-title>
            <mat-card-subtitle>Taux d'humidit√©</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="flex-1 flex flex-col justify-center">
            @if (isLoading) {
              <div class="text-center">
                <mat-icon class="animate-spin text-4xl text-blue-500 mb-4">refresh</mat-icon>
                <div class="text-gray-600">Chargement...</div>
              </div>
            } @else if (donneeEnTempsReel) {
              <div class="text-center">
                <div class="text-4xl font-bold text-blue-600 mb-2">
                  {{ donneeEnTempsReel.humidite | number:'1.0-0' }}%
                </div>
                <div class="text-sm text-gray-600 mb-4">
                  Conditions: {{ donneeEnTempsReel.conditionsMeteo }}<br>
                  Nuages: {{ donneeEnTempsReel.nuageux | number:'1.0-0' }}%
                </div>
                <mat-progress-bar
                  mode="determinate"
                  [value]="getHumiditeProgress()"
                  color="primary">
                </mat-progress-bar>
              </div>
            } @else {
              <div class="text-center text-gray-500">
                <mat-icon class="text-4xl mb-2">water_drop_off</mat-icon>
                <div>Aucune donn√©e</div>
              </div>
            }
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="primary">Tendances</button>
          </mat-card-actions>
        </mat-card>
      </mat-grid-tile>

      <!-- Carte Indice UV -->
      <mat-grid-tile>
        <mat-card class="w-full h-full hover-azure">
          <mat-card-header>
            <mat-icon
              mat-card-avatar
              [style.background-color]="getUVColor()"
              class="text-white">
              wb_sunny
            </mat-icon>
            <mat-card-title>Indice UV</mat-card-title>
            <mat-card-subtitle>Rayonnement solaire</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="flex-1 flex flex-col justify-center">
            @if (isLoading) {
              <div class="text-center">
                <mat-icon class="animate-spin text-4xl text-blue-500 mb-4">refresh</mat-icon>
                <div class="text-gray-600">Chargement...</div>
              </div>
            } @else if (donneeEnTempsReel) {
              <div class="text-center">
                <div class="text-4xl font-bold mb-2" [style.color]="getUVColor()">
                  {{ donneeEnTempsReel.indiceUv | number:'1.0-0' }}
                </div>
                <div class="text-sm text-gray-600 mb-4">
                  Niveau: {{ getUVLevel() }}<br>
                  Vent: {{ donneeEnTempsReel.vitesseVentKph | number:'1.1-1' }} km/h
                </div>
                <mat-progress-bar
                  mode="determinate"
                  [value]="getUVProgress()"
                  [color]="getUVProgress() < 50 ? 'primary' : 'warn'">
                </mat-progress-bar>
              </div>
            } @else {
              <div class="text-center text-gray-500">
                <mat-icon class="text-4xl mb-2">wb_sunny_off</mat-icon>
                <div>Aucune donn√©e</div>
              </div>
            }
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="primary">Protection</button>
          </mat-card-actions>
        </mat-card>
      </mat-grid-tile>

    </mat-grid-list>

    <!-- Section Donn√©es D√©taill√©es -->
    @if (donneeEnTempsReel && !isLoading) {
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
          <mat-icon class="mr-2 text-blue-500">analytics</mat-icon>
          Donn√©es D√©taill√©es du Capteur {{ donneeEnTempsReel.idCapteur }}
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Localisation -->
          <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center mb-2">
              <mat-icon class="text-blue-600 mr-2">place</mat-icon>
              <h3 class="font-semibold text-gray-800">Localisation</h3>
            </div>
            <p class="text-sm text-gray-600">{{ donneeEnTempsReel.localisation }}</p>
            <p class="text-xs text-gray-500 mt-1">{{ donneeEnTempsReel.coordonnees }}</p>
          </div>

          <!-- Pr√©cipitations -->
          <div class="bg-indigo-50 p-4 rounded-lg">
            <div class="flex items-center mb-2">
              <mat-icon class="text-indigo-600 mr-2">water_drop</mat-icon>
              <h3 class="font-semibold text-gray-800">Pr√©cipitations</h3>
            </div>
            <p class="text-lg font-bold text-indigo-600">
              {{ donneeEnTempsReel.precipitationMm | number:'1.1-1' }} mm
            </p>
            <p class="text-xs text-gray-500">Derni√®res 24h</p>
          </div>

          <!-- Pollution NO2 -->
          <div class="bg-orange-50 p-4 rounded-lg">
            <div class="flex items-center mb-2">
              <mat-icon class="text-orange-600 mr-2">air</mat-icon>
              <h3 class="font-semibold text-gray-800">NO2</h3>
            </div>
            <p class="text-lg font-bold text-orange-600">
              {{ donneeEnTempsReel.no2 | number:'1.1-1' }} Œºg/m¬≥
            </p>
            <p class="text-xs text-gray-500">Dioxyde d'azote</p>
          </div>

          <!-- Ozone O3 -->
          <div class="bg-green-50 p-4 rounded-lg">
            <div class="flex items-center mb-2">
              <mat-icon class="text-green-600 mr-2">eco</mat-icon>
              <h3 class="font-semibold text-gray-800">O3</h3>
            </div>
            <p class="text-lg font-bold text-green-600">
              {{ donneeEnTempsReel.o3 | number:'1.1-1' }} Œºg/m¬≥
            </p>
            <p class="text-xs text-gray-500">Ozone</p>
          </div>
        </div>

        <!-- Informations sur le capteur -->
        <div class="mt-6 pt-6 border-t border-gray-200">
          <div class="flex items-center justify-between text-sm text-gray-600">
            <div class="flex items-center space-x-4">
              <span>Capteur: {{ donneeEnTempsReel.nomCapteur }}</span>
              <span>Type: {{ donneeEnTempsReel.typeCapteur }}</span>
              <span>Source: {{ donneeEnTempsReel.sourceApi }}</span>
            </div>
            <div class="flex items-center space-x-2">
              <mat-icon class="text-green-500 text-sm">check_circle</mat-icon>
              <span>{{ donneeEnTempsReel.statutDonnee }}</span>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Section Alertes R√©centes -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <mat-icon class="mr-2 text-yellow-500">notifications</mat-icon>
        Alertes et Notifications
      </h2>
      <div class="space-y-3">
        <!-- Alerte bas√©e sur les donn√©es r√©elles -->
        @if (donneeEnTempsReel) {
          @if (donneeEnTempsReel.indiceUv > 7) {
            <div class="flex items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-400">
              <mat-icon class="text-red-600 mr-3">warning</mat-icon>
              <div class="flex-1">
                <div class="font-medium text-gray-800">Indice UV √©lev√© d√©tect√©</div>
                <div class="text-sm text-gray-600">
                  Niveau {{ getUVLevel() }} ({{ donneeEnTempsReel.indiceUv | number:'1.0-0' }}) - Protection recommand√©e
                </div>
              </div>
            </div>
          }

          @if (donneeEnTempsReel.pm10 > 50) {
            <div class="flex items-center p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
              <mat-icon class="text-yellow-600 mr-3">warning</mat-icon>
              <div class="flex-1">
                <div class="font-medium text-gray-800">Qualit√© de l'air d√©grad√©e</div>
                <div class="text-sm text-gray-600">
                  PM10: {{ donneeEnTempsReel.pm10 | number:'1.1-1' }} Œºg/m¬≥ - √âvitez les activit√©s ext√©rieures intenses
                </div>
              </div>
            </div>
          }

          @if (donneeEnTempsReel.temperatureCelsius > 30) {
            <div class="flex items-center p-3 bg-orange-50 rounded-lg border-l-4 border-orange-400">
              <mat-icon class="text-orange-600 mr-3">thermostat</mat-icon>
              <div class="flex-1">
                <div class="font-medium text-gray-800">Temp√©rature √©lev√©e</div>
                <div class="text-sm text-gray-600">
                  {{ donneeEnTempsReel.temperatureCelsius | number:'1.1-1' }}¬∞C - Restez hydrat√©
                </div>
              </div>
            </div>
          }
        }

        <!-- Alerte syst√®me par d√©faut -->
        <div class="flex items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
          <mat-icon class="text-blue-600 mr-3">info</mat-icon>
          <div class="flex-1">
            <div class="font-medium text-gray-800">Syst√®me de surveillance actif</div>
            <div class="text-sm text-gray-600">
              Capteurs IoT en fonctionnement - Donn√©es mises √† jour toutes les 30 secondes
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions Rapides -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <button mat-stroked-button class="p-4 h-20 flex items-center justify-center space-x-3 hover-azure">
        <mat-icon class="text-2xl text-blue-500">location_on</mat-icon>
        <span>Capteurs pr√®s de moi</span>
      </button>

      <button mat-stroked-button class="p-4 h-20 flex items-center justify-center space-x-3 hover-azure">
        <mat-icon class="text-2xl text-green-500">analytics</mat-icon>
        <span>Historique des donn√©es</span>
      </button>

      <button mat-stroked-button class="p-4 h-20 flex items-center justify-center space-x-3 hover-azure" (click)="refreshData()">
        <mat-icon class="text-2xl text-purple-500">refresh</mat-icon>
        <span>Actualiser maintenant</span>
      </button>

      <button
        mat-stroked-button
        class="p-4 h-20 flex items-center justify-center space-x-3 hover-azure"
        (click)="goToCommentaires()">
        <mat-icon class="text-2xl text-purple-500">comment</mat-icon>
        <span>Espace Commentaires</span>
      </button>

      <button mat-stroked-button class="p-4 h-20 flex items-center justify-center space-x-3 hover-azure" (click)="refreshData()">
        <mat-icon class="text-2xl text-orange-500">refresh</mat-icon>
        <span>Actualiser maintenant</span>
      </button>

    </div>

  </div>
</div>

<app-footer></app-footer>
